<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Làm Việc Tuần</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            color: white;
            padding: 10px;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }

        .search-section {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
        }

        .form-group {
            flex: 1;
            min-width: 150px;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            color: #444;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .search-btn {
            background-color: #2575fc;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .search-btn:hover {
            background-color: #1a68e8;
        }

        .current-week {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            font-size: 1rem;
            font-weight: 600;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .day {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            padding: 12px;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }

        .day-name {
            font-weight: bold;
            font-size: 1rem;
        }

        .date {
            color: #666;
            font-size: 0.8rem;
        }

        .full-date {
            color: #2575fc;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .task {
            background-color: #f8f9fa;
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 6px;
            border-left: 4px solid #2575fc;
        }

        .task-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .task-time {
            background: #2575fc;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .task-details {
            font-size: 0.8rem;
            color: #555;
        }

        .task-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            justify-content: flex-end;
        }

        .task-actions button {
            font-size: 0.8rem;
            padding: 3px 6px;
            border-radius: 4px;
            border: 1px solid transparent;
        }

        .edit-btn { color: #3498db; border-color: #3498db; }
        .edit-btn:hover { background: #3498db; color: white; }
        .delete-btn { color: #e74c3c; border-color: #e74c3c; }
        .delete-btn:hover { background: #e74c3c; color: white; }

        .add-task-btn {
            background-color: #2575fc;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 6px;
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .controls button {
            padding: 6px 12px;
            border-radius: 5px;
            border: none;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .controls button:hover {
            background-color: #2575fc;
            color: white;
        }

        @media (max-width: 992px) { .calendar { grid-template-columns: repeat(4, 1fr); } }
        @media (max-width: 768px) { .calendar { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 480px) { .calendar { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<div class="container">
    <header><h1>Lịch Làm Việc Tuần</h1></header>

    <div class="search-section">
        <form class="search-form" id="searchForm">
            <div class="form-group"><label for="searchDate">Tìm theo ngày</label><input type="date" id="searchDate"></div>
            <div class="form-group"><label for="searchWeek">Tuần</label><input type="number" id="searchWeek" min="1" max="53"></div>
            <div class="form-group"><label for="searchYear">Năm</label><select id="searchYear"></select></div>
            <div><button type="submit" class="search-btn"><i class="fas fa-search"></i> Tìm</button></div>
        </form>
    </div>

    <div class="current-week" id="currentWeekDisplay"></div>

    <div class="controls">
        <button id="prevWeek"><i class="fas fa-chevron-left"></i> Trước</button>
        <button id="today"><i class="fas fa-calendar-day"></i> Hôm nay</button>
        <button id="nextWeek">Sau <i class="fas fa-chevron-right"></i></button>
        <button id="exportExcel"><i class="fas fa-file-excel"></i> Xuất Excel</button>
    </div>

    <div class="calendar" id="calendar"></div>
</div>

<!-- Modal -->
<div class="modal" id="taskModal" style="display:none;">
    <div class="modal-content" style="background:white;padding:20px;border-radius:8px;max-width:500px;width:90%;margin:auto;">
        <h2 id="modalTitle" style="text-align:center;color:#2575fc;">Thêm Cuộc Họp</h2>
        <form id="taskForm">
            <input type="hidden" id="taskId">
            <input type="hidden" id="taskDay">
            <div class="form-group"><label>Nội dung</label><input type="text" id="taskTitle" required></div>
            <div class="form-group"><label>Thời gian</label><input type="text" id="taskTime" required></div>
            <div class="form-group"><label>Địa điểm</label><input type="text" id="taskLocation"></div>
            <div class="form-group"><label>Ghi chú</label><textarea id="taskDescription"></textarea></div>
            <div class="form-actions" style="text-align:right;margin-top:10px;">
                <button type="button" id="cancelBtn" class="cancel-btn">Hủy</button>
                <button type="submit" class="save-btn">Lưu</button>
            </div>
        </form>
    </div>
</div>

<script>
const firebaseConfig = { 
  apiKey : "AIzaSyA-PqImoRNDnLYybE4tqziDk-fPnSsz0UY",
  authDomain : "lich-lam-viec-mttq.firebaseapp.com",
  databaseURL : "https://lich-lam-viec-mttq-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId : "lich-lam-viec-mttq",
  storageBucket : "lich-lam-viec-mttq.firebasestorage.app",
  messagingSenderId : "281876982617",
  appId : "1:281876982617:web:87a6e064497fe26c70ba48"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

document.addEventListener('DOMContentLoaded', () => {
    const calendar = document.getElementById('calendar');
    const prevWeekBtn = document.getElementById('prevWeek');
    const todayBtn = document.getElementById('today');
    const nextWeekBtn = document.getElementById('nextWeek');
    const taskModal = document.getElementById('taskModal');
    const taskForm = document.getElementById('taskForm');
    const modalTitle = document.getElementById('modalTitle');
    const cancelBtn = document.getElementById('cancelBtn');
    const currentWeekDisplay = document.getElementById('currentWeekDisplay');
    const searchForm = document.getElementById('searchForm');
    const searchDate = document.getElementById('searchDate');
    const searchWeek = document.getElementById('searchWeek');
    const searchYear = document.getElementById('searchYear');

    let currentDate = new Date();
    function getMonday(d){d=new Date(d);const day=d.getDay(),diff=d.getDate()-day+(day===0?-6:1);return new Date(d.setDate(diff));}
    let monday = getMonday(currentDate);

    function formatDate(date){const d=date.getDate(),m=date.getMonth()+1,y=date.getFullYear();return`${d<10?'0'+d:d}/${m<10?'0'+m:m}/${y}`;}
    function getWeekNumber(date){const oneJan=new Date(date.getFullYear(),0,1);return Math.ceil((((date-oneJan)/86400000)+oneJan.getDay()+1)/7);}
    function getDateFromWeek(week,year){const simple=new Date(year,0,1+(week-1)*7);const dow=simple.getDay();if(dow<=4)simple.setDate(simple.getDate()-simple.getDay()+1);else simple.setDate(simple.getDate()+8-simple.getDay());return simple;}
    function getWeekId(){return `${monday.getFullYear()}-W${getWeekNumber(monday)}`;}

    function updateWeekDisplay(){
        const weekNumber=getWeekNumber(monday);
        const sunday=new Date(monday);sunday.setDate(monday.getDate()+6);
        currentWeekDisplay.textContent=`Tuần ${weekNumber} (${formatDate(monday)} - ${formatDate(sunday)})`;
    }

    function populateYearDropdown(){
        const curY=new Date().getFullYear();
        for(let y=curY-5;y<=curY+5;y++){
            const o=document.createElement('option');
            o.value=y;o.textContent=y;
            if(y===curY)o.selected=true;
            searchYear.appendChild(o);
        }
    }

    function renderCalendar(){
        calendar.innerHTML='';
        const days=['Thứ Hai','Thứ Ba','Thứ Tư','Thứ Năm','Thứ Sáu','Thứ Bảy','Chủ Nhật'];
        for(let i=0;i<7;i++){
            const d=new Date(monday);d.setDate(monday.getDate()+i);
            const dayDiv=document.createElement('div');dayDiv.className='day';
            const header=document.createElement('div');header.className='day-header';
            header.innerHTML=`<div class="day-name">${days[i]}</div><div class="date">${formatDate(d)}</div>`;
            const tasks=document.createElement('div');tasks.className='tasks';tasks.id=`tasks-${i}`;
            loadTasks(i,tasks);
            const btn=document.createElement('button');btn.className='add-task-btn';btn.innerHTML='<i class="fas fa-plus"></i> Thêm';btn.onclick=()=>openAddTaskModal(i);
            dayDiv.append(header,tasks,btn);
            calendar.append(dayDiv);
        }
        updateWeekDisplay();
    }

    function loadTasks(i,container){
        const ref=database.ref(`weeks/${getWeekId()}/days/${i}/tasks`);
        ref.on('value',snap=>{
            container.innerHTML='';
            const data=snap.val();
            if(data){Object.entries(data).forEach(([id,t])=>container.append(createTaskEl(i,id,t)));}
        });
    }

    function createTaskEl(i,id,t){
        const el=document.createElement('div');el.className='task';
        el.innerHTML=`<div class="task-header">
            <span class="task-title">${t.title}</span>
            <span class="task-time">${t.time}</span>
        </div>
        <div class="task-details">${t.description||''}</div>
        <div class="task-actions">
            <button class="edit-btn"><i class="fas fa-edit"></i></button>
            <button class="delete-btn"><i class="fas fa-trash"></i></button>
        </div>`;
        el.querySelector('.edit-btn').onclick=()=>openEditTaskModal(i,id,t);
        el.querySelector('.delete-btn').onclick=()=>deleteTask(i,id);
        return el;
    }

    function openAddTaskModal(i){modalTitle.textContent='Thêm Cuộc Họp';taskForm.reset();taskModal.style.display='flex';document.getElementById('taskDay').value=i;}
    function openEditTaskModal(i,id,t){modalTitle.textContent='Sửa Cuộc Họp';taskModal.style.display='flex';
        document.getElementById('taskDay').value=i;document.getElementById('taskId').value=id;
        document.getElementById('taskTitle').value=t.title;document.getElementById('taskTime').value=t.time;
        document.getElementById('taskLocation').value=t.location||'';document.getElementById('taskDescription').value=t.description||'';
    }

    function saveTask(i,id,data){return database.ref(`weeks/${getWeekId()}/days/${i}/tasks/${id}`).set(data);}
    function deleteTask(i,id){if(confirm('Xóa cuộc họp này?'))database.ref(`weeks/${getWeekId()}/days/${i}/tasks/${id}`).remove();}

    taskForm.onsubmit=e=>{
        e.preventDefault();
        const i=document.getElementById('taskDay').value;
        const id=document.getElementById('taskId').value||Date.now().toString();
        const data={
            title:document.getElementById('taskTitle').value,
            time:document.getElementById('taskTime').value,
            location:document.getElementById('taskLocation').value,
            description:document.getElementById('taskDescription').value
        };
        saveTask(i,id,data).then(()=>{taskModal.style.display='none';});
    };
    cancelBtn.onclick=()=>taskModal.style.display='none';

    prevWeekBtn.onclick=()=>{monday.setDate(monday.getDate()-7);renderCalendar();};
    todayBtn.onclick=()=>{monday=getMonday(new Date());renderCalendar();};
    nextWeekBtn.onclick=()=>{monday.setDate(monday.getDate()+7);renderCalendar();};

    searchForm.onsubmit=e=>{
        e.preventDefault();
        const date=searchDate.value,week=searchWeek.value,year=searchYear.value;
        if(date){monday=getMonday(new Date(date));renderCalendar();}
        else if(week&&year){monday=getDateFromWeek(parseInt(week),parseInt(year));renderCalendar();}
        else alert('Chọn ngày hoặc nhập tuần + năm');
    };

    // --- Xuất Excel ---
    function exportToExcel(){
        const weekRef=database.ref(`weeks/${getWeekId()}/days`);
        weekRef.once('value').then(snap=>{
            const data=snap.val();
            if(!data){alert('Không có dữ liệu');return;}
            const rows=[];const days=['Thứ Hai','Thứ Ba','Thứ Tư','Thứ Năm','Thứ Sáu','Thứ Bảy','Chủ Nhật'];
            for(let i=0;i<7;i++){
                const d=data[i];
                if(d&&d.tasks){
                    Object.values(d.tasks).forEach(t=>{
                        rows.push({
                            "Thứ":days[i],
                            "Ngày":formatDate(new Date(monday.getFullYear(),monday.getMonth(),monday.getDate()+i)),
                            "Giờ":t.time||'',
                            "Nội dung":t.title||'',
                            "Ghi chú":t.description||''
                        });
                    });
                }
            }
            if(rows.length===0){alert('Không có cuộc họp nào');return;}
            const wb=XLSX.utils.book_new();
            const ws=XLSX.utils.json_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb,ws,"Lịch Tuần");
            XLSX.writeFile(wb,`Lich_Tuan_${getWeekId()}.xlsx`);
        });
    }
    document.getElementById('exportExcel').onclick=exportToExcel;

    populateYearDropdown();
    renderCalendar();
});
</script>
</body>
</html>
